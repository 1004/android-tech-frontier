如何提高你的代码质量
---
> * 原文链接 : [How to improve quality and syntax of your Android code](http://vincentbrison.com/2014/07/19/how-to-improve-quality-and-syntax-of-your-android-code/)
* 原文作者 : [VINCENT BRISON](http://vincentbrison.com/)
* [译文出自 :  开发技术前线 www.devtf.cn](http://www.devtf.cn)
* 译者 : [dengshiwei](https://github.com/dengshiwei) 
* 校对者: [这里校对者的github用户名](github链接)  
* 状态 :  未完成 / 校对中 / 完成 

In this article, I will present different ways of improving your Android code with automatic tools such as Checkstyle, Findbugs,  PMD, and of course Android Lint. Test your code in an automated way can be very useful, especially when you are working with teammates, in order to maintain a rigorous syntax through your code, and avoid a lot of bad practices and errors. I will explain precisely how to use these tools directly through your Gradle build script, and how to configure them at your convenience.

在这篇文章中，我将通过不同的自动化工具如CheckStyle，FindBugs，PMD以及Android Lint来介绍(如何)提高你的安卓代码质量。通过自动化的方式检查你的代码非常有用，尤其当你在一个团队中工作，为了在你的代码中保持严格的语法格式以及避免很多坏习惯和错误。我将仔细地介绍如何在你空闲的时候直接运用这些工具通过Gradle构建脚本以及如何配置它们。

				Contents
	0.1 Fork the example !
	0.2 About Gradle tasks
	0.3 About the hierarchy of my demo project :
	1 Checkstyle
	1.1 Presentation
	1.2 The Gradle way
	1.3 Tricks for checkstyle
	2 Findbugs
	2.1 Presentation
	2.2 The Gradle way
	2.3 Tricks for Findbugs
	3 PMD
	3.1 Presentation
	3.2 The Gradle way
	3.3 Tricks for PMD
	4 Android Lint
	4.1 Presentation
	4.2 The Gradle way
	4.3 Tricks for Android Lint
	5 One task to rule them all
	6 Conclusion

			目录
	0.1 拷贝案例
	0.2 Gradle任务
	0.3 演示项目的层次结构
	1 Checkstyle
	1.1 简介
	1.2 Gradle的形式
	1.3 Checkstyle的使用技巧
	2 Findbugs
	2.1 简介
	2.2 Gradle的形式
	2.3 Findbugs的使用技巧
	3 PMD
	3.1 简介
	3.2 Gradle的形式
	3.3 PMD的使用技巧
	4 Android Lint
	4.1 简介
	4.2 Gradle的形式
	4.3 Android Lint的使用技巧
	5 实例演示
	6 总结

###Fork the example !

I strongly recommend you to fork [the following project](https://github.com/vincentbrison/vb-android-app-quality.git), since all the examples I will present come from it. At the same time, you will be able to test yourself these quality tools.

###拷贝案例
我强烈建议你拷贝下[这个项目工程](https://github.com/vincentbrison/vb-android-app-quality.git)，尽管我将介绍的案例都是来自它。与此同时，你将能够测试下自己对这些工具的了解情况。

###About Gradle tasks

The concept of task (in the Gradle meaning) is a fundamental for the understanding of this article (and how write Gradle script in a more general way). I strongly recommend you to take a look at the documentation of Gradle about tasks ([this one](https://docs.gradle.org/current/userguide/tutorial_using_tasks.html) and [this one](https://docs.gradle.org/current/userguide/more_about_tasks.html)). This documentation is full of examples,  so its very easy to dive in. So now I suppose you forked my repo, you imported the project into your Android Studio, and you are familiar with Gradle tasks. If not, don’t worry, I will make my best to make my explanations meaningful ;).

###关于Gradle任务
Gradle任务的概念(在Gradle中的含义)是理解该篇文章(以及如何以一种通用的方式写Gradle脚本)的基础。我强烈建议你去看下这两篇关于Gradle任务的文档（[这篇](https://docs.gradle.org/current/userguide/tutorial_using_tasks.html)和[这篇](https://docs.gradle.org/current/userguide/more_about_tasks.html)）。这个文档包含了大量的例子，因此它非常容易开始学习。现在，我假定你拷贝了我的Repo，你导入这个工程到你的Android Studio，并且你熟悉Gradle任务。如果不是，别担心，我将尽我最大的努力让我的讲解更有意义。

###About the hierarchy of my demo project :

Since you can split your gradle script in many files, I currently have 3 gradles files :

* [The one in the root folder](https://github.com/vincentbrison/vb-android-app-quality/blob/master/build.gradle), which is more or less just about configuration for the project (which maven repos to use, which Gradle version to use….).

* [The one in the subfolder app](https://github.com/vincentbrison/vb-android-app-quality/blob/master/app/build.gradle), which is a very classic       gradle file to build an Android application.

* [The one in the subfolder config](https://github.com/vincentbrison/vb-android-app-quality/blob/master/config/quality.gradle), on which we will focus on, since I use this one to retain and configure all my quality tools for my project.

###关于演示项目的层次结构

你可以将gradle脚本文件分割成很多文件，我现在已经有3个gradle文件：

* [根文件夹中的文件](https://github.com/vincentbrison/vb-android-app-quality/blob/master/build.gradle)，这些文件或多或少都是关于这个项目的配置的(用的哪个Maven Repos，用的哪个版本的Gradle)。
* [App子文件夹中的文件](https://github.com/vincentbrison/vb-android-app-quality/blob/master/app/build.gradle),这些文件是典型的用于创建安卓应用的gradle文件。
* [config子文件夹中的文件](https://github.com/vincentbrison/vb-android-app-quality/blob/master/config/quality.gradle)，这里的文件才是我们关系的重点，因为我用这里的文件保存和配置项目中的所有工具。

##Checkstyle

[![Checkstyle](http://checkstyle.sourceforge.net/images/logo.png)](http://checkstyle.sourceforge.net/)

###Presentation

“Checkstyle is a development tool to help programmers write Java code that adheres to a coding standard. It automates the process of checking Java code to spare humans of this boring (but important) task.”

As said by the  developers of Checkstyle, this tool help you to define and maintain in a very precise and flexible way the coding standards of a project. When you launch Checkstyle, it will parse your Java code and will inform you about all the errors found according the configuration provided.

###简介

"Checkstyle是一个开发工具用来帮助程序员编写符合代码规范的Java代码。它能自动检查Java代码为空闲的人进行这项无聊(但重要)的任务。"

正如Checkstyle的开发者所言，这个工具能够帮助你在项目中定义和维持一个非常精确和灵活的代码规范形式。当你启动CheckStyle，它会根据所提供的配置文件分析你的Java代码并告诉你发现的所有错误。

###The Gradle way
The following code show you the basic configuration to use Checkstyle in your project (as a Gradle task) :

	task checkstyle(type: Checkstyle) {
	configFile file("${project.rootDir}/config/quality/checkstyle/checkstyle.xml") // Where my checkstyle config is...
	configProperties.checkstyleSuppressionsPath = file("${project.rootDir}/config/quality/checkstyle/suppressions.xml").absolutePath // Where is my suppressions file for checkstyle is...
	source 'src'
	include '**/*.java'
	exclude '**/gen/**'
	classpath = files()
	}
So, basically this task will analyse your code according to the checkstyle.xml and the suppressions.xml. To execute it through Android Studio, just launch the task checkstyle from the gradle panel :

![gradle panel](http://vincentbrison.com/wp-content/uploads/2014/07/checkstyle.jpg)
     How to execute your gradle task checkstyle
	
After running checkstyle, you will have a report describing each problem founded in your project. That’s pretty straightforward.

If you want to do more configurations on checkstyle, just refer to the [documentation](https://docs.gradle.org/current/dsl/org.gradle.api.plugins.quality.Checkstyle.html);).

###Gradle的形式

下面的代码向你展示了在你的项目中使用Checkstyle的最基本的配置(如Gradle任务):

	task checkstyle(type: Checkstyle) {
	configFile file("${project.rootDir}/config/quality/checkstyle/checkstyle.xml") // Where my checkstyle config is...
	configProperties.checkstyleSuppressionsPath = file("${project.rootDir}/config/quality/checkstyle/suppressions.xml").absolutePath // Where is my suppressions file for checkstyle is...
	source 'src'
	include '**/*.java'
	exclude '**/gen/**'
	classpath = files()
	}

所以，基本上这个任务会根据checkstyle.xml和suppressions.xml分析你的代码。通过Android Studio执行它仅仅需要从工具面的CheckStyle来启动它。

![gradle panel](http://vincentbrison.com/wp-content/uploads/2014/07/checkstyle.jpg)
     How to execute your gradle task checkstyle

启动CheckStyle之后，你讲收到一个报告用于展示在你项目中发现的每个错误。这是非常直接的方式。

如果你想在checkstyle上做更多的配置，可以参考[这篇文档](https://docs.gradle.org/current/dsl/org.gradle.api.plugins.quality.Checkstyle.html)。

###Tricks for checkstyle

Checkstyle will detect a huge amount of problems, especially if you use a lot of rules, like in the case you want a very precise syntax. Even if I use checkstyle through Gradle, for example before my pushs, I recommend you to also use the plugin checkstyle for IntellJ/Android Studio (you can directly install it from Android Studio through the panel File/Settings/Plugins). This way you will be able to apply checkstyle to your project according the same configs files as specified for Gradle, but more than that, you will have access to the results directly in Android Studio, with hyperlinks to the problems in your code, which is pretty useful (The Gradle way is still very important since you can use it through automated build system like Jenkins).

###Checkstyle的使用技巧
Checkstyle会发现大量的问题，特别是在你运用了大量的规则配置，如同你设置了一个非常精确的语法。尽管我通过Gradle使用checkstyle，例如在我进行推送之前，我仍然推荐你为IntellJ/Android Studio使用checkstyle插件(你可以通过Android Studio的工作面板文件/设置/插件直接安装插件)。这种方式下，你可以根据那些为Gradle配置的相同文件在你的工程中使用checkstyle，但是远不止这些，你可以直接在Android Studio中获取带有超链接结果，这些结果通过超链接在你的代码中对应，这是非常有用的(Gradle的这种方式仍然很重要的，因为你可以使用它自动构建系统，如Jenkins)。

##Findbugs
[![Findbugs](http://findbugs.sourceforge.net/umdFindbugs.png)](http://findbugs.sourceforge.net/)
###Presentation

Does Findbugs need a presentation? I guess the name is meaningful. “FindBugs uses static analysis to inspect Java bytecode for occurrences of bug patterns.” Findbugs basically just need the bytecode of a program to do the analysis, so it is very easy to use. It will detect common error such as wrong boolean operator. Findbugs is also able to detect error due to misunderstood of language features, such as reassignment of parameters in Java (which is not really possible since it parameters are passed by values).

###简介

Findbugs是否需要一个简介呢？我想它的名称已经让人顾名思义了。“FindBugs使用静态分析方法为出现bug模式检查Java字节码”。FindBugs基本上只需要一个程序来做分析的字节码，所以这是非常容易使用。它能检测到常见的错误，如错误的布尔运算符。FindBugs也能够检测到由于误解语言特点的错误，如Java参数调整（这不是真的有可能因为它的参数是传值）。

###The Gradle way

The following code show you the basic configuration for use Findbugs in your project (as a Gradle task) :

	task findbugs(type: FindBugs) {
	ignoreFailures = false
	effort = "max"
	reportLevel = "high"
	excludeFilter = new File("${project.rootDir}/config/quality/findbugs/findbugs-filter.xml")
	classes = files("${project.rootDir}/app/build/classes")
 
	source 'src'
	include '**/*.java'
	exclude '**/gen/**'
 
	reports {
	xml.enabled = false
	html.enabled = true
	xml {
	destination "$project.buildDir/reports/findbugs/findbugs.xml"
	}
	html {
	destination "$project.buildDir/reports/findbugs/findbugs.html"
	}
	}
 
	classpath = files()
	}

So it looks a lot like the Checkstyle task. Since Findbugs support HTML and XML reports, I pick the HTML since the report is more readable. Moreover, you just need to bookmark the report location to have a quick access to it. This task will also failed if an error in Findbgus is detected (still producing a report). To execute the Findbugs task, that’s exactly like for the Checkstyle task (except that the name of the task is “findbugs”).

###Gradle的形式
下面的代码向你展示了在你的项目中使用Findbugs的最基本的配置(以Gradle任务为例):


	task findbugs(type: FindBugs) {
	ignoreFailures = false
	effort = "max"
	reportLevel = "high"
	excludeFilter = new File("${project.rootDir}/config/quality/findbugs/findbugs-filter.xml")
	classes = files("${project.rootDir}/app/build/classes")
 
	source 'src'
	include '**/*.java'
	exclude '**/gen/**'
 
	reports {
	xml.enabled = false
	html.enabled = true
	xml {
	destination "$project.buildDir/reports/findbugs/findbugs.xml"
	}
	html {
	destination "$project.buildDir/reports/findbugs/findbugs.html"
	}
	}
 
	classpath = files()
	}

它是如此的像一个Checkstyle任务。尽管Findbugs支持HTML和XML两种报告形式，我选择HTML形式，因为这种形式更具有可读性。而且，你只需要把报告的位置设置为书签就可以快速访问它的位置。这个任务也会失败如果发现Findbgus错误失败(同样生成报告)。执行FindBugs任务，就像执行CheckStyle任务（除了任务的名称是“FindBugs”）。

###Tricks for Findbugs

I strongly recommend to use a findbugs-filter, since Android project are slightly different from Java project. You can take example on this one (the one of the example project). It will basically ignore the R file and your Manifest file. By the way, since Findbugs analyse your bytecode, you need to compile at least one time your code to be able to test it.

###Findbugs的使用技巧

由于Android项目是从Java项目略有不同，我强烈推荐使用FindBugs过滤器(规则配置)。你可以在这一个例子（例如项目之一）。它基本上忽略了R文件和你的Manifest文件。顺便说一句，由于(使用)FindBugs分析你的代码，你至少需要编译一次你的代码才能够测试它。

##PMD

[![PMD](http://pmd.sourceforge.net/pmd_logo.png)](http://pmd.sourceforge.net/)

###Presentation

Funny fact of this tool : there is not a real name for PMD. On the offcicial website you will find very interesting names propositions as :

* Pretty Much Done
* Project Meets Deadline

In the facts, PMD is a very powerful tool which works a little bit like Findbugs, but inspect directly the source code, and not the bytecode (btw. PMD can work with plenty of languages). The goal is globally the same, find patterns which can lead to bugs using static analysis. So why use Findbugs and PMD at the same time ? Well, even if Findbugs and PMD share globally the same goals, their inspecting methods are different. So PMD can sometimes find bugs which Findbugs wont, and vice versa.

###简介

这个工具有个有趣的事实：PMD不存在一个准确的名称。(所以)在官网上你可以发现很有有趣的名称，例如:

* Pretty Much Done
* Project Meets Deadline

事实上，PMD是一个工作有点类似Findbugs的强大工具，但是(PMD)直接检查源代码而不是检查字节码(顺便说句，PMD适用很多语言)。(PMD和Findbugs)的核心目标是相同的，通过静态分析方法找出哪些模式引起的bug。因此为什么同时使用Findbugs和PMD呢？好吧！尽管Findbugs和PMD拥有相同的目标，(但是)他们的检查方法是不同的。所以PMD有时检查出的bug但是Findbugs却检查不出来，反之亦然。

###The Gradle way

The following code show you the basic configuration for use PMD in your project (as a Gradle task) :

	task pmd(type: Pmd) {
	ruleSetFiles = files("${project.rootDir}/config/quality/pmd/pmd-ruleset.xml")
	ignoreFailures = false
	ruleSets = []
 
	source 'src'
	include '**/*.java'
	exclude '**/gen/**'
 
	reports {
	xml.enabled = false
	html.enabled = true
	xml {
	destination "$project.buildDir/reports/pmd/pmd.xml"
	}
	html {
	destination "$project.buildDir/reports/pmd/pmd.html"
	}
	}
	}

For PMD, this is also almost the same as Findbugs. PMD can produce HTML or XML reports, so again I pick the HTML format. I strongly recommend you to use your own custom rulesets file as I’m doing in this example ([check this file](https://github.com/vincentbrison/vb-android-app-quality/blob/master/config/quality/pmd/pmd-ruleset.xml)). So of course, take a look at [the documentation about custom ruleset](http://pmd.sourceforge.net/pmd-5.1.1/howtomakearuleset.html). I recommend you that because PMD can be a lot more controversial than Findbugs. For example, it will basically warn you if you not collapse “if statement”, or if you have empty “if statement”. I’m really thinking that’s the job of you and your teammates to define, if these rules are right, or not, for your project. I know I prefer to not collapse if statement since, I think this is a lot less readable. To execute the PMD task, that’s exactly like for the Checkstyle task (except that the name of the task is “pmd”).

###Gradle的形式
下面的代码向你展示了在你的项目中使用PMD的最基本的配置(以Gradle任务为例):

	task pmd(type: Pmd) {
	ruleSetFiles = files("${project.rootDir}/config/quality/pmd/pmd-ruleset.xml")
	ignoreFailures = false
	ruleSets = []
 
	source 'src'
	include '**/*.java'
	exclude '**/gen/**'
 
	reports {
	xml.enabled = false
	html.enabled = true
	xml {
	destination "$project.buildDir/reports/pmd/pmd.xml"
	}
	html {
	destination "$project.buildDir/reports/pmd/pmd.html"
	}
	}
	}

就PMD来说，它几乎与Findbugs相同。PMD支持HTML和XML两种报告形式，所以我再次选择HTML形式。我强烈建议你使用自己的通用配置集文件，正如同我在这个例子([check this file](https://github.com/vincentbrison/vb-android-app-quality/blob/master/config/quality/pmd/pmd-ruleset.xml))中一样。所以，你当然应该去看下这些[通用配置集文件](http://pmd.sourceforge.net/pmd-5.1.1/howtomakearuleset.html)。我建议你，因为PMD可比FindBugs更有争议的很多，例如：如果你不声明"if statement"或"if statement"为空，它基本上会给你警告信息。如果这些规则是正确的，或这对于您的项目(来说是正确的)，我真的认可你和你队友的工作。我不希望程序因为"if statement"崩溃，我认为这样程序的可读性很差。执行PMD任务，就像是(执行)CheckStyle任务（除了任务的名称是“PMD”）。

###Tricks for PMD

As I recommend you to not use the default ruleSet, you need to add this line (already added above) :

	ruleSets = []

Otherwise, since the default value is the basic ruleset, the basic ruleset will always be executed alongside with your custom ruleset. So if you say in your custom ruleset to not use specific rules in the basic ruleset, they still will be considered.

###PMD的使用技巧

我建议你不要使用默认的规则配置集，你需要添加这行代码(已经加上)：

	ruleSets = []

否则，因为默认值是这些基本的规则配置集，基本的规则配置集会和你定义的规则集一起执行。所以，如果你的自定义规则集不在那些基本配置集中，他们仍然会执行。


##Android Lint

###Presentation

“The Android lint tool is a static code analysis tool that checks your Android project source files for potential bugs and optimization improvements for correctness, security, performance, usability, accessibility, and internationalization.”

As the official site said, Android Lint is another static analysis tool, dedicated this time to Android. It is extremely powerful, and can give great piece of advice to improve the quality of your code.

###简介

“Android lint工具是一个静态代码分析工具，它能检查安卓项目源文件的潜在缺陷和优化改进的正确性，安全性，性能，可用性，可访问性和国际化。”

正如官方网站所说，Android Lint是另一种静态分析工具，专门为Android服务。它是非常强大的，能给你大量的建议以提高你的代码质量。

###The Gradle way

	android {
	lintOptions {
	abortOnError true
 
	lintConfig file("${project.rootDir}/config/quality/lint/lint.xml")
 
	// if true, generate an HTML report (with issue explanations, sourcecode, etc)
	htmlReport true
	// optional path to report (default will be lint-results.html in the builddir)
	htmlOutput file("$project.buildDir/reports/lint/lint.html")
	}

I recommend you to use a separate file to define which rules to use or not. [This website](http://tools.android.com/tips/lint-checks) defines all the rules from the latest ADT version. The lint file of my demo project contains all these rules (ADT 21) with the “severity” level at “ignore” except for this article :

* IconDensities : This rule ensure that you define each image resource in each density (except ldpi).

* IconDipSize : This rule ensure that you define rightfully the resource for each dip (in other terms, check if you did not put the same image resource for each density, without re-sized it).

So you can reuse this lint file and activate all the rules you want. To execute the Android Lint task, that’s exactly like for the Checkstyle task (except that the name of the task is “lint”).

###Gradle的形式

	android {
	lintOptions {
	abortOnError true
 
	lintConfig file("${project.rootDir}/config/quality/lint/lint.xml")
 
	// if true, generate an HTML report (with issue explanations, sourcecode, etc)
	htmlReport true
	// optional path to report (default will be lint-results.html in the builddir)
	htmlOutput file("$project.buildDir/reports/lint/lint.html")
	}

我建议你使用一个单独的文件来定义哪些配置需要使用和不使用。[这个网站](http://tools.android.com/tips/lint-checks)根据最新的ADT版本定义了全部的配置。我的演示项目中的lint文件包含所有这些规则（ADT 21），包含等级为"ignore"的"severity":

* IconDensities：这个规则配置确保你定义每个图像资源中的(分辨率)密度（除了ldpi）。

* IconDipSize:这个规则配置确保你为每个dip定义合适的资源(换句话来说，如果你没有为每个density设置相同的图片资源，则不需要重新设置图片大小)。

所以你可以重用这个lint文件并激活你想要的所有规则。执行Android Lint任务，就像执行CheckStyle任务（除了任务的名称是"lint"）。

###Tricks for Android Lint

No special tricks for android lint, just keep in mind that Android Lint will always test all the rules except the one set with a “severity” level at “ignore”. So if new rules are released with new version of ADT, they will be examined, and not ignored.

###Android Lint的使用技巧

对于Android Lint没有什么特别的技巧，只需要牢记Android Lint会测试所有配置规则，除了那些等级为“ignore”的“severity”的配置。因此如果发布了新版本ADT下的新配置规则，他们将被检查，而不是忽视。

##One task to rule them all

Now, you have all the keys to use 4 quality tools for your projects. But obviously it would be better if we could use these 4 tools at the same time. You can add dependency between your gradle tasks, like for example when you execute one task, the others ones are executed after the completion of the first one. Usually with Gradle, you add dependencies of your quality tools with the “check” task :

	check.dependsOn 'checkstyle', 'findbugs', 'pmd', 'lint'

Now, when executing the “check” tasks, Checkstyle, Findbugs, PMD, and Android Lint will be executed. That’s a great way of checking the quality of what you are doing before / commiting / pushing / ask merge request :).

You can find a full example of all these tasks in [the following gradle file](https://github.com/vincentbrison/vb-android-app-quality/blob/master/config/quality.gradle). You can separate all the quality configurations and gradle files from the source as you can see in the demo example, where everything is packaged in the “config/quality” folder.

##实例演示

现在，你有所有的方法为您的项目使用这四个工具。显然，如果我们能同时使用这四个工具会更好。你可以添加你的gradle任务之间的依赖，比如当你执行一个任务，其他任务则是第一个完成后执行。通常在Gradle中，通过让工具具有“check”任务来达到工具之间的相互关系：

	check.dependsOn 'checkstyle', 'findbugs', 'pmd', 'lint'

现在，当执行“check” 任务的时候，Checkstyle, Findbugs, PMD, and Android Lint将会同时执行。在你执行/ commiting / pushing / ask merge request 之前进行质量检查是一个很棒的方式。

你可以在[这个Gradle文件](https://github.com/vincentbrison/vb-android-app-quality/blob/master/config/quality.gradle)中找到所有任务的一个完整例子。你可以把所有的质量配置文件和Gradle文件从你看到的演示实例中分开，这些演示的实例把一起都放在“config/quality” 文件夹下。

##Conclusion

As presented in this article, the use of quality tools for Android is very easy with Gradle. More than using quality tools locally to check your project on your own computer, these tools can be used in automated build plateform like Jenkins/Hudson, allowing you to automate the process of quality, alongside with your automated build process. To execute all the tests I presented from the CLI, like to execute it on Jenkins/Hudson, simply execute :

	gradle check

Please feel free to comment this article, or ask any questions relative to quality for Android.

#总结
在这篇文章中，利用Gradle对Android使用代码质量检查工具是非常容易。比使用质量工具局部检查您的项目在您自己的计算机上，这些工具可以用于自动构建如Jenkins/Hudson这样的平台，让你自动进行质量检查，同时自动建立过程。执行所有我从CLI展现的测试，如同在Jenkins/Hudson上执行，简单地执行：

	gradle check

请随时对这篇文章发表评论，或者问任何有关Android的问题。
